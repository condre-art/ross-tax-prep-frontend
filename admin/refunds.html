<div style="text-align:center;margin:32px 0;">
  <button id="ai-marketing-btn" style="background:linear-gradient(90deg,#C9A24D 60%,#ffe9a0 100%);color:#0F2A44;font-family:'Montserrat',sans-serif;font-weight:700;border:none;border-radius:8px;padding:18px 38px;font-size:1.2em;box-shadow:0 2px 8px #c9a24d33;cursor:pointer;transition:background 0.2s,color 0.2s,box-shadow 0.2s;">Post AI Marketing Now</button>
  <div style="font-size:0.98em;color:#0F2A44;margin-top:8px;">(Posts a random AI-generated marketing message, poll, or image to your linked social media.)</div>
  <div id="ai-marketing-analytics" style="margin-top:18px;padding:16px 0 0 0;font-size:1.05em;"></div>
</div>
<script src="../scripts/ai-marketing-widget.js"></script>
<script src="../scripts/ai-marketing-analytics.js"></script>
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/webp" href="../assets/ross-logo.webp" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Refund Tracker – Admin</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    .refund-table { width:100%; border-collapse:collapse; margin-top:2em; }
    .refund-table th, .refund-table td { border:1px solid #e5e7eb; padding:8px 12px; }
    .refund-table th { background:#f3f4f6; }
    .status-badge { padding:2px 8px; border-radius:4px; font-size:0.95em; }
    .status-pending { background:#fffbe6; color:#b59f3b; }
    .status-disbursed { background:#e6ffed; color:#1a7f37; }
    .status-rejected { background:#ffe6e6; color:#b53b3b; }
    .status-sent { background:#e6f0ff; color:#2a4fb3; }
  </style>
</head>
<body>
  <div class="admin-layout" style="display:flex;min-height:100vh;">
    <aside class="sidebar" style="background:#0F2A44;color:#fff;width:220px;padding:32px 0 0 0;display:flex;flex-direction:column;align-items:center;">
      <img src="../assets/ross-logo.webp" class="header-logo" alt="Logo" style="width:120px;margin-bottom:18px;" />
      <nav style="display:flex;flex-direction:column;gap:16px;width:100%;">
        <a href="index.html" style="color:#fff;padding:8px 24px;">Dashboard</a>
        <a href="staff.html" style="color:#fff;padding:8px 24px;">Staff</a>
        <a href="clients.html" style="color:#fff;padding:8px 24px;">Clients</a>
        <a href="returns.html" style="color:#fff;padding:8px 24px;">Returns</a>
        <a href="efile.html" style="color:#fff;padding:8px 24px;">E-File</a>
        <a href="refunds.html" style="color:#C9A24D;padding:8px 24px;font-weight:bold;">Refund Tracker</a>
        <a href="tasks.html" style="color:#fff;padding:8px 24px;">Tasks</a>
        <a href="onboarding-staff.html" style="color:#fff;padding:8px 24px;">Staff Onboarding</a>
        <a href="register-staff.html" style="color:#fff;padding:8px 24px;">Register Staff</a>
        <a href="compliance.html" style="color:#fff;padding:8px 24px;">Compliance</a>
        <a href="settings.html" style="color:#fff;padding:8px 24px;">Settings</a>
        <a href="../index.html" style="color:#C9A24D;padding:8px 24px;">Public Site</a>
      </nav>
    </aside>
    <div style="flex:1;display:flex;flex-direction:column;min-height:100vh;">
      <header style="background:#fff;border-bottom:1px solid #e5e7eb;padding:18px 32px;display:flex;align-items:center;justify-content:space-between;">
        <div class="breadcrumbs" style="font-size:0.95rem;color:#888;">
          Admin &gt; Refund Tracker
        </div>
      </header>
      <main class="section" style="flex:1;">
        <div class="section-inner">
          <h2>Refund Tracker</h2>
          <div style="margin-bottom:1em;">
            <input id="searchInput" type="text" placeholder="Search by client, return, status, method..." style="padding:6px 12px;width:320px;max-width:100%;" />
            <button onclick="loadRefunds()" style="padding:6px 18px;margin-left:8px;">Search</button>
          </div>
          <table class="refund-table" id="refundTable">
            <thead>
              <tr>
                <th>Client</th>
                <th>Return</th>
                <th>Status</th>
                <th>Method</th>
                <th>Amount</th>
                <th>Disbursed</th>
                <th>Trace ID</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="refundTableBody">
              <tr><td colspan="9">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </main>
      <footer style="background:#0F2A44;color:#fff;text-align:center;padding:18px 0;">© 2026 Ross Tax & Bookkeeping. Internal Use Only.<br>
        <a href="../privacy.html" style="color:#ffe9a0;text-decoration:underline;font-size:0.98em;">Privacy Policy</a> |
        <a href="../terms.html" style="color:#ffe9a0;text-decoration:underline;font-size:0.98em;">Terms of Service</a> |
        <a href="../breach-notification.html" style="color:#ffe9a0;text-decoration:underline;font-size:0.98em;">Breach Notification Policy</a>
      </footer>
    </div>
  </div>
  <script>
    async function loadRefunds() {
      const q = document.getElementById('searchInput').value.trim();
      let url = '/api/admin/refunds';
      if (q) url += '?q=' + encodeURIComponent(q);
      const res = await fetch(url);
      const data = await res.json();
      const tbody = document.getElementById('refundTableBody');
      tbody.innerHTML = '';
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="9">No results found.</td></tr>';
        return;
      }
      for (const r of data) {
        tbody.innerHTML += `<tr>
          <td>${r.client_name || ''}</td>
          <td>${r.return_id || ''}</td>
          <td><span class="status-badge status-${(r.irs_refund_status||'pending').replace(/\s/g,'-').toLowerCase()}">${r.irs_refund_status||'pending'}</span></td>
          <td>${r.refund_method||''}</td>
          <td>${r.refund_amount!=null?('$'+r.refund_amount.toFixed(2)):'—'}</td>
          <td>${r.refund_disbursed_at||'—'}</td>
          <td>${r.refund_trace_id||'—'}</td>
          <td>${r.refund_notes||''}</td>
          <td><button onclick="editRefund('${r.id}')">Edit</button></td>
        </tr>`;
      }
    }
    async function editRefund(id) {
      const row = prompt('Update refund status (JSON: irs_refund_status, refund_method, refund_amount, refund_disbursed_at, refund_trace_id, refund_notes):');
      if (!row) return;
      try {
        const body = JSON.parse(row);
        const res = await fetch('/api/efile/refund/' + id, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (res.ok) loadRefunds();
        else alert('Update failed');
      } catch { alert('Invalid JSON'); }
    }
    loadRefunds();
  </script>
</body>
</html>
