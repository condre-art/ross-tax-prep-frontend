<!-- CRM Dashboard with Authentication (Admin/Staff Only) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM | Ross Tax & Bookkeeping</title>
  <link rel="stylesheet" href="/styles/main.css" />
  <link rel="icon" type="image/webp" href="/assets/ross-logo.webp" />
  <style>
    body { font-family: 'Georgia', serif; background: linear-gradient(135deg, #10274D 80%, #E1B773 100%); margin: 0; min-height: 100vh; }
    .crm-container { max-width: 1100px; margin: 2em auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #0002; padding: 2em; }
    .crm-header { display: flex; align-items: center; gap: 1em; margin-bottom: 1.5em; }
    .crm-header img { height: 60px; }
    .crm-header h1 { color: #10274D; font-size: 2em; margin: 0; }
    .crm-table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    .crm-table th, .crm-table td { border: 1px solid #e5e7eb; padding: 10px 14px; text-align: left; }
    .crm-table th { background: #10274D; color: #fff; }
    .crm-table tr:nth-child(even) { background: #f7f9fa; }
    .crm-actions { margin-bottom: 1em; display: flex; gap: 1em; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
    .btn-primary { background: #E1B773; color: #10274D; }
    .btn-danger { background: #b53b3b; color: #fff; }
    .login-form { max-width: 400px; margin: 4em auto; background: #fff; border-radius: 18px; padding: 2em; box-shadow: 0 4px 24px #0002; }
    .login-form h2 { color: #10274D; margin-bottom: 1em; }
    .login-form input { width: 100%; padding: 12px; margin-bottom: 1em; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
    .login-form .btn { width: 100%; }
    .error { color: #b53b3b; margin-bottom: 1em; }
    .badge { display: inline-block; padding: 2px 10px; border-radius: 6px; font-size: 0.9em; }
    .badge-active { background: #e6ffed; color: #1a7f37; }
    .badge-expired { background: #fffbe6; color: #b59f3b; }
    .badge-revoked { background: #ffe6e6; color: #b53b3b; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Login Form (shown if not authenticated) -->
    <div id="login-section" class="login-form" style="display:none;">
      <h2>CRM Login</h2>
      <div id="login-error" class="error" style="display:none;"></div>
      <input type="email" id="login-email" placeholder="Email" required />
      <input type="password" id="login-password" placeholder="Password" required />
      <button class="btn btn-primary" onclick="doLogin()">Login</button>
    </div>

    <!-- CRM Dashboard (shown if authenticated) -->
    <div id="crm-section" class="crm-container" style="display:none;">
      <div class="crm-header">
        <img src="/assets/ross-logo.webp" alt="Logo" />
        <h1>Client Intake CRM</h1>
        <span style="margin-left:auto;">
          <span id="user-info"></span>
          <button class="btn btn-danger" onclick="doLogout()">Logout</button>
        </span>
      </div>
      <div class="crm-actions">
        <button class="btn btn-primary" onclick="refreshIntakes()">Refresh</button>
      </div>
      <table class="crm-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Service</th>
            <th>Notes</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="intakes-body">
          <tr><td colspan="6">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = ""; // Use relative URLs

    function getToken() {
      return localStorage.getItem("crm_token");
    }
    function setToken(token) {
      localStorage.setItem("crm_token", token);
    }
    function clearToken() {
      localStorage.removeItem("crm_token");
    }

    async function doLogin() {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      const errEl = document.getElementById("login-error");
      errEl.style.display = "none";
      try {
        const res = await fetch(API_BASE + "/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.token) {
          setToken(data.token);
          showCRM();
        } else {
          errEl.textContent = data.error || "Login failed";
          errEl.style.display = "block";
        }
      } catch (e) {
        errEl.textContent = "Network error";
        errEl.style.display = "block";
      }
    }

    function doLogout() {
      clearToken();
      showLogin();
    }

    function showLogin() {
      document.getElementById("login-section").style.display = "block";
      document.getElementById("crm-section").style.display = "none";
    }

    function showCRM() {
      document.getElementById("login-section").style.display = "none";
      document.getElementById("crm-section").style.display = "block";
      refreshIntakes();
    }

    async function refreshIntakes() {
      const token = getToken();
      const tbody = document.getElementById("intakes-body");
      tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
      try {
        const res = await fetch(API_BASE + "/api/crm/intakes", {
          headers: { "Authorization": "Bearer " + token }
        });
        if (res.status === 401) {
          clearToken();
          showLogin();
          return;
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = "<tr><td colspan='6'>No intakes found.</td></tr>";
          return;
        }
        tbody.innerHTML = data.map(r => `
          <tr>
            <td>${escapeHtml(r.full_name || "")}</td>
            <td>${escapeHtml(r.email || "")}</td>
            <td>${escapeHtml(r.phone || "")}</td>
            <td>${escapeHtml(r.service || "")}</td>
            <td>${escapeHtml(r.notes || "")}</td>
            <td>${r.created_at ? new Date(r.created_at).toLocaleString() : ""}</td>
          </tr>
        `).join("");
      } catch (e) {
        tbody.innerHTML = "<tr><td colspan='6'>Error loading intakes.</td></tr>";
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[s]));
    }

    // On page load, check for token
    (function init() {
      if (getToken()) {
        showCRM();
      } else {
        showLogin();
      }
    })();
  </script>
</body>
</html>
